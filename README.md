create or replace PROCEDURE P_PROCESS_DATA_INSERT 
(
P_COIL_ID VARCHAR2,
MIN_RUNID VARCHAR2,
MAX_RUNID VARCHAR2,
ISSUCESS OUT VARCHAR2
) AS 
--P_COIL_ID VARCHAR2(20);
START_TIME TIMESTAMP:= SYSDATE;
H_STM_ID VARCHAR2(50);
BEGIN
--SELECT COIL_ID INTO P_COIL_ID FROM T_SPM_COIL_PROCESSING WHERE LOCATION ='POR'; --AND FLAG_ID=110;
H_STM_ID:='SELECT 1';
--SELECT DATE_TIME INTO START_TIME FROM SPML2.T_EVENT_LOG WHERE COIL_ID=P_COIL_ID AND ID_APP_TAG='L1_COIL_START' ORDER BY DATE_TIME ASC FETCH FIRST 1 ROW ONLY;

INSERT INTO T_SPM_PROCESS_DATA_LEVEL2
(
MSG_ID,
SOURCE_APPLN,
DESTN_APPLN,
ELONGATION_ACT,
COIL_ID,
-----POR---
POR_TEN_MIN,
POR_TEN_MAX,
POR_TEN_AVG,
POR_UNIT_TENSION,
POR_SPD_MIN,
POR_SPD_MAX,
POR_SPD_AVG,
POR_DIA,
POR_TORQUE,
POR_CURRENT,
----DTR-----
DTR_TEN_MIN,
DTR_TEN_MAX,
DTR_TEN_AVG,
DTR_UNIT_TENSION,
DTR_SPD_MIN,
DTR_SPD_MAX,
DTR_SPD_AVG,
DTR_DIA,
DTR_TORQUE,
--DTR_WRAPS,
DTR_CURRENT,
-----DRF/TRF----
DRF_MIN,
DRF_MAX,
DRF_AVG,
TRF_MIN,
TRF_MAX,
TRF_AVG,
--------MILL--------
MILL_DRIVE_CUR_MIN,
MILL_DRIVE_CUR_MAX,
MILL_DRIVE_CUR_AVG,
MILL_SPEED_MIN,
MILL_SPEED_MAX,
MILL_SPEED_AVG,
TORQUE_MIN,
TORQUE_MAX,
TORQUE_AVG,
----TILT----
TILT_MIN,
TILT_MAX,
TIL_AVG,
----ENTR BR-------
ENT_BR_TENSION_MIN,
ENT_BR_TENSION_MAX,
ENT_BR_TENSION_AVG,
ENT_BR_TORQUE_MIN,
ENT_BR_TORQUE_MAX,
ENT_BR_TORQUE_AVG,
ENT_TOP_BR_CUR_MIN,
ENT_TOP_BR_CUR_MAX,
ENT_TOP_BR_CUR_AVG,
ENT_BOT_BR_CUR_MIN,
ENT_BOT_BR_CUR_MAX,
ENT_BOT_BR_CUR_AVG,
---------EXIT BR--
EXT_BR_TENSION_MIN,
EXT_BR_TENSION_MAX,
EXT_BR_TENSION_AVG,
EXT_BR_TORQUE_MIN,
EXT_BR_TORQUE_MAX,
EXT_BR_TORQUE_AVG,
EXT_TOP_BR_CUR_MIN,
EXT_TOP_BR_CUR_MAX,
EXT_TOP_BR_CUR_AVG,
EXT_BOT_BR_CUR_MIN,
EXT_BOT_BR_CUR_MAX,
EXT_BOT_BR_CUR_AVG,

--------DF------------
DEFLECTOR1_SPD_MIN,
DEFLECTOR1_SPD_MAX,
DEFLECTOR1_SPD_AVG,
DEFLECTOR2_SPD_MIN,
DEFLECTOR2_SPD_MAX,
DEFLECTOR2_SPD_AVG,

-------------
---BENDING-----
WR_P_BEND_MIN,
WR_P_BEND_MAX,
WR_P_BEND_AVG,
WR_N_BEND_MIN,
WR_N_BEND_MAX,
WR_N_BEND_AVG,
ROCKER_PLATE_POS,
WEDGE_POS,
---GAP---
GAP_DS_MIN,
GAP_DS_MAX,
GAP_DS_AVG,
GAP_OS_MIN,
GAP_OS_MAX,
GAP_OS_AVG--,
---ROLLFORCE---
--ROLL_FORCE_OS_MIN,
--ROLL_FORCE_OS_MAX,
--ROLL_FORCE_OS_AVG,
--ROLL_FORCE_DS_MIN,
--ROLL_FORCE_DS_MAX,
--ROLL_FORCE_DS_AVG


--COIL_ID
)

SELECT 
F_NANNOW_SECOND_TELGRM(SYSDATE),
'SPML2',
'C3DIS',
--ROUND(AVG(L1_ELG_ACT),2),
1,
P_COIL_ID,
----POR
ROUND(MIN(POR_Tension),2),
ROUND(MAX(POR_Tension),2),
ROUND(AVG(POR_Tension),2),
1,
ROUND(MAX(POR_Dia),2),
ROUND(AVG(POR_Dia),2),
ROUND(AVG(POR_Dia),2),

ROUND(MAX(POR_Speed),2),
ROUND(AVG(POR_Speed),2),
ROUND(AVG(POR_Speed),2),
---DTR------
ROUND(MIN(DTR_Tension),2),
ROUND(MAX(DTR_Tension),2),
ROUND(AVG(DTR_Tension),2),
1,
ROUND(MAX(DTR_Dia),2),
ROUND(AVG(DTR_Torque),2),
ROUND(AVG(L1_DTR_CURRENT),2),
ROUND(MAX(DTR_Speed),2),
ROUND(AVG(DTR_Speed),2),
ROUND(AVG(DTR_Speed),2),
-------DRF/TRF--------
--ROUND(MIN(L1_DRF_ACT),2),
--ROUND(MAX(L1_DRF_ACT),2),
--ROUND(AVG(L1_DRF_ACT),2),
--ROUND(MIN(L1_TRF_ACT),2),
--ROUND(MAX(L1_TRF_ACT),2),
--ROUND(AVG(L1_TRF_ACT),2),
--0,
0,
0,
0,
0,
0,
0,



-------MILLL----
ROUND(MIN(Mill_Drive_Current_Top),2),
ROUND(MAX(Mill_Drive_Current_Top),2),
ROUND(AVG(Mill_Drive_Current_Top),2),
ROUND(MIN(Mill_Speed),2),
ROUND(MAX(Mill_Speed),2),
ROUND(AVG(Mill_Speed),2),
ROUND(MIN(DTR_Torque),2),
ROUND(MAX(DTR_Torque),2),
ROUND(AVG(DTR_Torque),2),
-----TILT-------
--ROUND(MIN(L1_TILT_ACT),2),
--ROUND(MAX(L1_TILT_ACT),2),
--ROUND(AVG(L1_TILT_ACT),2),
0,
0,
0,
--------ENT BR----------
--ROUND(MIN(L1_ENT_BR_TENSION),2),
--ROUND(MAX(L1_ENT_BR_TENSION),2),
--ROUND(AVG(L1_ENT_BR_TENSION),2),
--ROUND(MIN(L1_ENT_TOP_TORQUE),2),
--ROUND(MAX(L1_ENT_TOP_TORQUE),2),
--ROUND(AVG(L1_ENT_TOP_TORQUE),2),
--ROUND(MIN(L1_ENT_TOP_BR_CUR),2),
--ROUND(MAX(L1_ENT_TOP_BR_CUR),2),
--ROUND(AVG(L1_ENT_TOP_BR_CUR),2),
--ROUND(MIN(L1_ENT_BOT_CUR),2),
--ROUND(MAX(L1_ENT_BOT_CUR),2),
--ROUND(AVG(L1_ENT_BOT_CUR),2),
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,

------------EXIT BR-----
--ROUND(MIN(L1_EXIT_BR_TENSION),2),
--ROUND(MAX(L1_EXIT_BR_TENSION),2),
--ROUND(AVG(L1_EXIT_BR_TENSION),2),
--ROUND(MIN(L1_EXIT_TOP_TORQUE),2),
--ROUND(MAX(L1_EXIT_TOP_TORQUE),2),
--ROUND(AVG(L1_EXIT_TOP_TORQUE),2),
--ROUND(MIN(L1_EXIT_TOP_BR_CUR),2),
--ROUND(MAX(L1_EXIT_TOP_BR_CUR),2),
--ROUND(AVG(L1_EXIT_TOP_BR_CUR),2),
--ROUND(MIN(L1_EXIT_BOT_BR_CUR),2),
--ROUND(MAX(L1_EXIT_BOT_BR_CUR),2),
--ROUND(AVG(L1_EXIT_BOT_BR_CUR),2),
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,
0,
------------DF-------------------
--ROUND(MIN(L1_ENT_DF_ROLL_SPEED),2),
--ROUND(MAX(L1_ENT_DF_ROLL_SPEED),2),
--ROUND(AVG(L1_ENT_DF_ROLL_SPEED),2),
--ROUND(MIN(L1_EXIT_DF_ROLL_SPEED),2),
--ROUND(MAX(L1_EXIT_DF_ROLL_SPEED),2),
--ROUND(AVG(L1_EXIT_DF_ROLL_SPEED),2),
0,
0,
0,
0,
0,
0,
------BENDING--------------
--ROUND(MIN(L1_WR_P_PRES),2),
--ROUND(MAX(L1_WR_P_PRES),2),
--ROUND(AVG(L1_WR_P_PRES),2),
--ROUND(MIN(L1_WR_N_PRES),2),
--ROUND(MAX(L1_WR_N_PRES),2),
--ROUND(AVG(L1_WR_N_PRES),2),
0,0,0,0,0,0,

round(AVG(Rocker_plate_position),2),
ROUND(AVG(Wedge_position),2),
---GAP---
ROUND(MIN(Pass_line),2),
ROUND(MAX(Pass_line),2),
ROUND(AVG(Pass_line),2),
ROUND(MIN(Pass_line),2),
ROUND(MAX(Pass_line),2),
ROUND(AVG(Pass_line),2)
---ROLLFORCE---
--ROUND(MIN(Total_Load),2),
--ROUND(MAX(Total_Load),2),
--ROUND(AVG(Total_Load),2),
--ROUND(MIN(Total_Load),2),
--ROUND(MAX(Total_Load),2),
--ROUND(AVG(Total_Load),2)


FROM T_PERIODIC_VALUE_LOG
    WHERE RUN_ID BETWEEN MIN_RUNID AND MAX_RUNID
      AND Mill_speed > 15;


ISSUCESS:='S';
EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
    --   ISSUCESS:='F';
     WHEN OTHERS THEN
     --ISSUCESS:='F';
       -- HANDL_EERROR('SPM_LEVEL2','P_SETPOINT_UPDATE_HMI ',h_stm_id,sqlcode,substr(sqlerrm(sqlcode),1,100),null,'T_SPM_PROCESS_DATA_LEVEL2');
     COMMIT;
     COMMIT;
END P_PROCESS_DATA_INSERT;
