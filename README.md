Connecting to the database SPML2.
Debugger attempting to connect to database.
Executing PL/SQL: DECLARE
                    id VARCHAR2( 30 );
                  BEGIN
                    id := DBMS_DEBUG.initialize( '127.0.0.1:1764659424269', 0 );
                    DBMS_DEBUG.debug_on( TRUE );
                  END;
Debugger connected to database.
Source breakpoint: P_DELAY_REGISTER.pls:26
Debugger connection to debuggee process has been lost.
ORA-00604: error occurred at recursive SQL level 1
ORA-01013: user requested cancel of current operation
ORA-06510: PL/SQL: unhandled user-defined exception
ORA-00604: error occurred at recursive SQL level 1
ORA-01013: user requested cancel of current operation
ORA-06512: at "SPML2.P_DELAY_REGISTER", line 40
ORA-06512: at line 2
Executing PL/SQL: BEGIN
                    DBMS_DEBUG.debug_off();
                  END;
Process exited.
Disconnecting from the database SPML2.
Debugger disconnected from database.
create or replace PROCEDURE       P_DELAY_REGISTER IS
 
P_LINE_SPEED NUMBER;

TIME_DELAY TIMESTAMP;

DELAY_STATUS VARCHAR2(3);

DELAY_END TIMESTAMP;

  H_STM_ID VARCHAR2(200):=NULL;

  P_SHIFT VARCHAR2(5):='ERROR';

  SPEED_ZERO_NUM NUMBER :=0;

  HSD_MESSAGE VARCHAR2(36):=NULL;


A_SHIFT TIMESTAMP(6):= TRUNC(SYSDATE) + 6/24;

B_SHIFT TIMESTAMP(6):= TRUNC(SYSDATE) + 14/24;

C_SHIFT TIMESTAMP(6):= TRUNC(SYSDATE) + 22/24;

MID_NIGHT TIMESTAMP(6):=TRUNC(SYSDATE+1) + 00/24;

BEGIN

   H_STM_ID:='select 1';

   SELECT MILL_SPEED INTO P_LINE_SPEED FROM T_PERIODIC_VALUE_LOG ORDER BY RUN_ID DESC FETCH FIRST 1 ROW ONLY ;

   --SELECT COUNT(*) INTO SPEED_ZERO_NUM FROM T_PERIODIC_VALUE_LOG WHERE (date_time > sysdate - interval '5' minute) AND L1_LINE_SPEED=0;

   IF P_LINE_SPEED < 20 THEN

   H_STM_ID:='select 2';

     SELECT REMARKS INTO DELAY_STATUS FROM T_DELAY_SHEET WHERE LINE_STOP_TIME IS NOT NULL ORDER BY LINE_STOP_TIME DESC FETCH FIRST 1 ROW ONLY;

       IF  DELAY_STATUS!= 'R'THEN

        H_STM_ID:='SELECT 3';

          SELECT MIN(DATE_TIME)INTO TIME_DELAY FROM T_PERIODIC_VALUE_LOG WHERE MILL_SPEED<20 and (date_time > sysdate - interval '5' minute) ;

          SELECT CASE 

--           WHEN TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '06:00' AND '14:00' THEN 'A'
--
--           WHEN TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '14:00' AND '22:00' THEN 'B'
--
--          WHEN (TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '22:00' AND '23:59') 
--          OR (TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '00:00' AND '06:00')  THEN 'C'
-- added by annu
        WHEN TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '06:00' AND '13:59' THEN 'A'
        WHEN TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '14:00' AND '21:59' THEN 'B'
        WHEN TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '22:00' AND '23:59'
             OR TO_CHAR(TIME_DELAY,'HH24:MI') BETWEEN '00:00' AND '05:59' THEN 'C'
          END 

      INTO P_SHIFT FROM DUAL;

-- added by annu
--        SELECT CASE
--            WHEN TO_CHAR(TIME_DELAY, 'HH24:MI') BETWEEN '06:00' AND '13:59' THEN 'A'
--            WHEN TO_CHAR(TIME_DELAY, 'HH24:MI') BETWEEN '14:00' AND '21:59' THEN 'B'
--            ELSE 'C'
--        END INTO P_SHIFT FROM DUAL;

       H_STM_ID:='Insert 1';

       HSD_MESSAGE:=F_NANNOW_SECOND_TELGRM(TIME_DELAY);

         INSERT INTO T_DELAY_SHEET (LINE_STOP_TIME ,REMARKS,SHIFT,ID_MESSAGE) VALUES (TIME_DELAY,'R',P_SHIFT,HSD_MESSAGE);

      END IF; 

      IF DELAY_STATUS='R' THEN

        SELECT LINE_STOP_TIME INTO  TIME_DELAY FROM T_DELAY_SHEET WHERE LINE_STOP_TIME IS NOT NULL ORDER BY LINE_STOP_TIME DESC FETCH FIRST 1 ROW ONLY; 

       H_STM_ID:='SELECT A SHIFT';

        IF ( (TIME_DELAY<A_SHIFT )AND(A_SHIFT < SYSDATE) ) THEN

          UPDATE T_DELAY_SHEET SET LINE_START_TIME=A_SHIFT,DELAY_DURATION=TIME_DIFF_MINTE(TIME_DELAY,A_SHIFT),REMARKS='E',TOM=SYSDATE WHERE REMARKS='R';

           INSERT INTO T_DELAY_SHEET (LINE_STOP_TIME ,REMARKS,SHIFT,ID_MESSAGE) VALUES (A_SHIFT,'R','A',F_NANNOW_SECOND_TELGRM(A_SHIFT));

        END IF;

        H_STM_ID:='SELECT B SHIFT';

         IF ( (TIME_DELAY<B_SHIFT )AND(B_SHIFT < SYSDATE) )  THEN

           UPDATE T_DELAY_SHEET SET LINE_START_TIME=B_SHIFT,DELAY_DURATION=TIME_DIFF_MINTE(TIME_DELAY,B_SHIFT),REMARKS='E',TOM=SYSDATE WHERE REMARKS='R';

          INSERT INTO T_DELAY_SHEET (LINE_STOP_TIME ,REMARKS,SHIFT,ID_MESSAGE) VALUES (B_SHIFT,'R','B',F_NANNOW_SECOND_TELGRM(B_SHIFT));

          END IF;

          H_STM_ID:='SELECT C SHIFT';

         IF ((TIME_DELAY<C_shift ) and (C_shift<sysdate) )THEN

          UPDATE T_DELAY_SHEET SET LINE_START_TIME=C_SHIFT,DELAY_DURATION=TIME_DIFF_MINTE(TIME_DELAY,C_shift),REMARKS='E',TOM=SYSDATE WHERE REMARKS='R';

          INSERT INTO T_DELAY_SHEET (LINE_STOP_TIME ,REMARKS,SHIFT,ID_MESSAGE) VALUES (C_SHIFT,'R','C',F_NANNOW_SECOND_TELGRM(B_SHIFT));

        END IF;

      END IF;

   END IF;

   IF P_LINE_SPEED >= 20 THEN

   H_STM_ID:='SELECT 4';

   --  SELECT COUNT(*) INTO SPEED_ZERO_NUM FROM T_PERIODIC_VALUE_LOG WHERE (date_time > sysdate - interval '5' minute) AND L1_LINE_SPEED=0;

     SELECT REMARKS,LINE_STOP_TIME INTO DELAY_STATUS,TIME_DELAY FROM T_DELAY_SHEET WHERE LINE_STOP_TIME IS NOT NULL ORDER BY LINE_STOP_TIME DESC FETCH FIRST 1 ROW ONLY;

      IF DELAY_STATUS='R' THEN

      H_STM_ID:='SELECT 5';

       SELECT MIN(DATE_TIME) INTO DELAY_END FROM T_PERIODIC_VALUE_LOG WHERE MILL_SPEED!=0 and (date_time > sysdate - interval '5' minute) ;

      H_STM_ID:='UPDATE 1';

       UPDATE T_DELAY_SHEET SET LINE_START_TIME=DELAY_END,DELAY_DURATION=TIME_DIFF_MINTE(TIME_DELAY,DELAY_END),REMARKS='E',TOM=SYSDATE WHERE REMARKS='R'; 

      END IF;

  END IF;

  dbms_output.put_line(SPEED_ZERO_NUM);

    dbms_output.put_line(DELAY_END);

   EXCEPTION

       WHEN OTHERS THEN 

     HANDL_EERROR('SPM','P_DELAY_REGISTER',h_stm_id,sqlcode,substr(sqlerrm(sqlcode),1,100),null,'T_DELAY_SHEET');

     COMMIT;

END P_DELAY_REGISTER;
